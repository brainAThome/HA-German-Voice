# ============================================================================
# ROLLADEN/COVER INTENTS - Modulare Datei
# ============================================================================
# Teil von: intent_script: !include_dir_merge_named intent_scripts/
# ============================================================================

SetSunProtection:
  action:
    - action: cover.set_cover_position
      target:
        area_id: "{{ area_id(area) }}"
      data:
        position: 30
  speech:
    text: >
      {% set responses = [
        "Sonnenschutz für " ~ area ~ " ist jetzt aktiv. Die Rolladen fahren auf 30 Prozent.",
        "Alles klar, Sonnenschutzmodus für " ~ area ~ " aktiviert.",
        "OK, " ~ area ~ " Rolladen sind jetzt im Sonnenschutz.",
        "Erledigt, " ~ area ~ " ist vor der Sonne geschützt.",
        "Geht klar, Sonnenschutz im " ~ area ~ " ist an."
      ] %}
      {{ responses | random }}

DisableSunProtection:
  action:
    - action: cover.open_cover
      target:
        area_id: "{{ area_id(area) }}"
  speech:
    text: >
      {% set responses = [
        "Sonnenschutz für " ~ area ~ " ist deaktiviert, die Rolladen fahren wieder hoch.",
        "Alles klar, " ~ area ~ " Rolladen öffnen sich wieder.",
        "OK, Sonnenschutz im " ~ area ~ " ist aus.",
        "Erledigt, " ~ area ~ " Sonnenschutz wurde beendet.",
        "Geht klar, " ~ area ~ " Rolladen gehen wieder auf."
      ] %}
      {{ responses | random }}

EnableCoverAutomation:
  action:
    - action: input_boolean.turn_on
      target:
        entity_id: "input_boolean.rolladen_automatik_{{ area | lower | replace(' ', '_') }}"
  speech:
    text: >
      {% set responses = [
        "Die Rolladen-Automatik für " ~ area ~ " ist jetzt eingeschaltet.",
        "Alles klar, " ~ area ~ " Automatik ist aktiv.",
        "OK, automatische Steuerung für " ~ area ~ " läuft.",
        "Erledigt, " ~ area ~ " wird jetzt automatisch gesteuert.",
        "Verstanden, Rolladen-Automatik im " ~ area ~ " ist an."
      ] %}
      {{ responses | random }}

DisableCoverAutomation:
  action:
    - action: input_boolean.turn_off
      target:
        entity_id: "input_boolean.rolladen_automatik_{{ area | lower | replace(' ', '_') }}"
  speech:
    text: >
      {% set responses = [
        "Rolladen-Automatik für " ~ area ~ " ist aus. Du kannst jetzt manuell steuern.",
        "Alles klar, " ~ area ~ " ist jetzt auf manuelle Steuerung.",
        "OK, Automatik für " ~ area ~ " deaktiviert.",
        "Erledigt, " ~ area ~ " läuft jetzt ohne Automatik.",
        "Verstanden, manuelle Kontrolle für " ~ area ~ " ist an."
      ] %}
      {{ responses | random }}

SetCoverScene:
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ 'morgen' in trigger_sentence or 'aufwach' in trigger_sentence or 'aufsteh' in trigger_sentence }}"
          sequence:
            - service: cover.open_cover
              target:
                entity_id: all
        - conditions:
            - condition: template
              value_template: "{{ 'nacht' in trigger_sentence or 'schlaf' in trigger_sentence }}"
          sequence:
            - service: cover.close_cover
              target:
                entity_id: all
        - conditions:
            - condition: template
              value_template: "{{ 'kino' in trigger_sentence or 'film' in trigger_sentence or 'heimkino' in trigger_sentence }}"
          sequence:
            - service: cover.close_cover
              target:
                entity_id: all
            - service: light.turn_off
              target:
                entity_id: all
      default:
        - service: cover.set_cover_position
          target:
            entity_id: all
          data:
            position: 50
  speech:
    text: >
      {% set responses = [
        "Die Szene ist jetzt aktiv!",
        "Alles klar, Szene wurde aktiviert.",
        "OK, die gewählte Szene läuft.",
        "Erledigt, Szene ist eingestellt.",
        "Verstanden, alles ist eingerichtet."
      ] %}
      {{ responses | random }}

GetCoverState:
  speech:
    text: >
      {% if name is defined and name %}
        {% set cover = 'cover.' ~ name | lower | replace(' ', '_') %}
        {% set display = name %}
      {% elif area is defined and area %}
        {% set display = area %}
        {% set cover = '' %}
      {% else %}
        {% set display = 'Unbekannt' %}
        {% set cover = '' %}
      {% endif %}
      {% if cover %}
        {% set state = states(cover) %}
        {% set pos = state_attr(cover, 'current_position') | default(0) %}
        {% if state == 'open' %}
          {% set responses = [
            "Die Rolladen im " ~ display ~ " sind geöffnet, aktuell bei " ~ pos ~ " Prozent.",
            "Im " ~ display ~ " sind die Rolladen offen, Position " ~ pos ~ " Prozent.",
            display ~ " Rolladen: offen bei " ~ pos ~ " Prozent."
          ] %}
          {{ responses | random }}
        {% elif state == 'closed' %}
          {% set responses = [
            "Die Rolladen im " ~ display ~ " sind komplett geschlossen.",
            "Im " ~ display ~ " sind die Rolladen zu.",
            display ~ " Rolladen sind unten."
          ] %}
          {{ responses | random }}
        {% elif state == 'opening' %}
          Die Rolladen im {{ display }} fahren gerade hoch.
        {% elif state == 'closing' %}
          Die Rolladen im {{ display }} fahren gerade runter.
        {% else %}
          {{ display }} hat den Status {{ state }} und ist bei {{ pos }} Prozent.
        {% endif %}
      {% else %}
        Rolladen in {{ display }}: Raumstatus kann nur für einzelne Rolladen abgefragt werden.
      {% endif %}

ScheduleCover:
  speech:
    text: >
      {% set time_map = {
        'morning': 'morgens',
        'noon': 'mittags',
        'evening': 'abends',
        'night': 'nachts',
        'sunrise': 'bei Sonnenaufgang',
        'sunset': 'bei Sonnenuntergang'
      } %}
      {% set time_text = time_map.get(time_of_day, time_of_day) %}
      {% set responses = [
        "Perfekt, ich übernehme das! Die Rolladen werden " ~ time_text ~ " automatisch gesteuert.",
        "Alles klar, Rolladen-Zeitplan für " ~ time_text ~ " ist gesetzt.",
        "OK, automatische Steuerung " ~ time_text ~ " aktiviert.",
        "Erledigt, die Rolladen fahren " ~ time_text ~ " automatisch.",
        "Verstanden, " ~ time_text ~ " werden die Rolladen automatisch bewegt."
      ] %}
      {{ responses | random }}
